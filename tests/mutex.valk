
use valk:core
use valk:thread
use valk:time

class MutexTestBuf {
    count: uint (0)
}

test "Mutex" {
    let m = core:Mutex[void].new() ! {
        assert(false)
        return
    }
    let buf = MutexTestBuf{}
    let ref = &buf.count
    let threads = Array[thread:Thread]{}
    m.lock()
    let x = 0
    while x++ < 4 {
        let t = thread:start(fn(){
            m.await_unlock()
            let i = 0
            while i++ < 1000 {
                m.lock()
                ref[0]++
                m.unlock()
            }
        }) ! {
            assert(false)
            m.unlock()
            return
        }
        threads.append(t)
    }
    time:sleep_ms(100)
    m.unlock()
    each threads as t {
        t.wait()
    }
    assert(buf.count == 4000)
}

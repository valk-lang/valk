
use valk:core
use valk:thread

test "Mutex" {
    let m = core:Mutex{}
    let counter = 0
    let ref = &counter
    let threads = Array[thread:Thread]{}
    m.lock()
    let x = 0
    while x++ < 2 {
        let t = thread:start(fn(){
            let i = 0
            while i++ < 1000 {
                m.lock()
                ref[0]++
                m.unlock()
            }
        }) ! {
            assert(false)
            m.unlock()
            return
        }
        threads.append(t)
    }
    m.unlock()
    each threads as t {
        t.wait()
    }
    assert(counter == 2000)
}